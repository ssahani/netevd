# Debian-based Docker image for netevd
# Larger size but better compatibility

# Build stage
FROM rust:1.70-bookworm as builder

WORKDIR /build

# Install dependencies
RUN apt-get update && \
    apt-get install -y \
    libdbus-1-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Copy manifests
COPY Cargo.toml Cargo.lock ./

# Copy source
COPY src ./src
COPY examples ./examples

# Build release binary
RUN cargo build --release

# Runtime stage
FROM debian:bookworm-slim

# Install runtime dependencies
RUN apt-get update && \
    apt-get install -y \
    libdbus-1-3 \
    iproute2 \
    systemd \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create netevd user
RUN useradd -r -M -s /usr/sbin/nologin -d /nonexistent netevd

# Copy binary from builder
COPY --from=builder /build/target/release/netevd /usr/bin/netevd

# Copy configuration
COPY examples/netevd.yaml /etc/netevd/netevd.yaml

# Create script directories
RUN mkdir -p /etc/netevd/{carrier.d,no-carrier.d,configured.d,degraded.d,routable.d,activated.d,disconnected.d,manager.d,routes.d}

# Set capabilities (if supported by runtime)
RUN setcap cap_net_admin+eip /usr/bin/netevd || true

# Don't run as root in production
USER netevd

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
    CMD /usr/bin/netevd --version || exit 1

ENTRYPOINT ["/usr/bin/netevd"]
CMD ["--config", "/etc/netevd/netevd.yaml"]
